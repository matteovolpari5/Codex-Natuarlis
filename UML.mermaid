classDiagram

%% DA TENERE
    Card <|-- PlaceableCard
    Card <|-- ObjectiveCard
    PlaceableCard <|-- DrawableCard
    DrawableCard <|-- GoldCard
    Deck~T~ o-- Card
    Deck~T~ <|-- PlayingDeck~T~
    PlayingDeck~T~ <|-- DrawableDeck~T~
    DrawableDeck~T~ <|-- ResourceCardsDeck
    DrawableDeck~T~ <|-- GoldCardsDeck
    Condition <|-- LayoutCondition
    Condition <|-- ItemsCondition
    Condition <|-- CornerCoverageCondition
    GameItem <|.. GameResource
    GameItem <|.. GameObject
    Chat o-- Message
    Message <|-- PrivateMessage
    LayoutCondition --> GameResource
    ItemsCondition --> GameItem
    GameField --> PlaceableCard
    %%Player --> PlaceableCard
    Player --> TokenColor
    %%Player --> ObjectiveCard
    ScoreTrackBoard --> Player
    %%GameController --> DrawableDeck
    %%GameController --> Deck
    %%GameController --> PlayingDeck
    %%GameController --> ScoreTrackBoard
    %%GameController --> Player
    %%GameController --> Chat
    %%GameController --> GameField
    GamesManager --> Game
    GameCommand <|-- AddChatPrivateMessageCommand
    GameCommand <|-- AddChatPublicMessageCommand
    GameCommand <|-- AddPlayerCommand
    GameCommand <|-- DisconnectPlayerCommand
    GameCommand <|-- PlaceCardCommand
    GameCommand <|-- ReconnectPlayerCommand
    GameCommand <|-- DrawFaceUpCardCommand
    GameCommand <|-- PlaceStarterCardCommand
    GameCommand <|-- DrawDeckCardCommand

    %% --------------------------------
    %% cards
    %% --------------------------------
    class Card {
        <<abstract>>
        - ID: int
        - TYPE: CardType
        + Card (id: int, type: CardType)
        + getId() int
        + getType() CardType
    }
    class PlaceableCard {
        - PERMANENTRESOURCES: List~GameResource~
        - FRONTCORNERS: boolean [4]
        - FRONTCORNERSCONTENT: GameItem [4]
        - BACKCORNERS: boolean [4]
        - BACKCORNERSCONTENT: GameItem [4]
        + PlaceableCard (cardID: int, cardType: CardType,\n frontCorners: boolean [4], \n frontCornersContent: GameItem [4],\n backCorners: boolean [4], \n backCornersContent: GameItem [4],\n permanentResources: List~GameResource~)
        + getFrontCorners() boolean [4]
        + getFrontCornersContent() GameItem[4]
        + getBackCorners() boolean [4]
        + getBackCornersContent() GameItem [4]
        + getPermanentResources() List~GameResource~
        + isPlaceable(gameField: Gamefield, x : int, y: int, \nway : boolean) PlacementResult
        + getPlacementScore(gameField: Gamefield, x : int, y: int) int
    }
    class DrawableCard {
        - PLACEMENTSCORE: int
        + DrawableCard(cardID: int, cardType: CardType, \nfrontCorners: boolean [4], frontCornersContent: GameItem [4],\nbackCorners: boolean [4], backCornersContent: GameItem [4],\n placementScore: int,\n permanentResources: List~GameResource~)
        + getScore() int
    }
    class GoldCard {
        - PLACEMENTCONDITION: Condition
        - SCORINGCONDITION: Condition
        + GoldCard(cardID: int, cardType: CardType,\n frontCorners: boolean[4], frontCornersContent: GameItem[4],\n backCorners: boolean[4], backCornersContent: GameItem[4], \nplacementScore: int, permanentResources: List~GameResource~, \nplacementCondition: Condition, scoringCondition: Condition)
    }
    class ObjectiveCard {
        - SCORINGCONDITION: Condition
        - OBJECTIVESCORE: int
        + ObjectiveCard(cardID int, cardType: CardType,\n scoringCondition: Condition, objectiveScore: int)
        + getObjectiveScore(gameField GameField) int
        + numTimesScoringConditionMet(gameField GameField) int
    }

    %% --------------------------------
    %% chat
    %% --------------------------------
    class Chat {
        - messages: List~Message~
        + Chat()
        + addMessage(content: String, sender: String, isPublic: boolean,\n receiver: String, players: List~String~)
        + getLastMessage(receiver: String) Message
        + getContent(receiver: String) List~Message~
    }
    class Message{
        - CONTENT: String
        - SENDERNICKNAME: String
        - ISPUBLIC: boolean
        + Message(content: String, senderNickname: String, isPublic: boolean)
        + getContent() String
        + getSender() String
        + isPublic() boolean
        + getReceiver() String
    }
    class PrivateMessage{
        - RECEIVERNICKNAME: String
        + PrivateMessage(content: String, senderNickname: String, isPublic: boolean, receiverNickname: String)
    }

    %% --------------------------------
    %% Conditions
    %% --------------------------------
    class Condition {
        <<interface>>
        + numTimesMet(gameField: GameField) int
    }
    class CornerCoverageCondition {
        + CornerCoverageCondition()
    }
    class ItemsCondition {
        - NEEDEDITEMS: List~GameItem~
        + ItemsCondition(neededItems: List~GameItem~)
        + getNeededItems() List~GameItem~
    }
    class LayoutCondition {
        - CARDSCOLOR: GameResource[4][3]
        - MAXLAYOUTROWS: int$
        - MAXLAYOUTCOLUMNS: int$
        + LayoutCondition(cardsColor: GameResource[3][3])
        + getCardsColor() GameResource[3][3]
    }

    %% --------------------------------
    %% Decks
    %% --------------------------------
    class Deck~T~{
        ~ TYPE: CardType
        ~ Stack~T~ content
        + Deck(type : CardType, content : Stack~T~ )
        + Deck(existingDeck : Deck~T~)
        + setType(type: CardType)
        + getType() CardType
        + getContent() Stack~T~
        + setContent(content : ~T~)
        + drawCard() T
        + shuffle()
    }
    class PlayingDeck~T~{
        ~ faceUpCards: List~T~
        + PlayingDeck(type : CardType, content : Stack~T~)
        + PlayingDeck(existingDeck : PlayingDeck~T~)
        + setFaceUpCards(faceUpCards: List~T~)
        + revealFaceUpCard(cardPos: int) ~T~
    }
    class DrawableDeck~T~{
        <<abstract>>
        + DrawableDeck(type : CardType, content : Stack~T~)
        + DrawableDeck( existingDeck : DrawableDeck~T~)
        + drawFaceUpCard(cardPos: int) ~T~
        ~ revealDeckCard() ~T~
    }
    class GoldCardsDeck{
        + GoldCardsDeck(type : CardType, content : Stack~GoldCard~)
        + GoldCardsDeck(existingDeck : GoldCardsDeck)
        + revealBackDeckCard() GameResource
    }
    class ResourceCardsDeck{
        + ResourceCardsDeck(type : CardType, content: Stack~DrawableCard~)
        + ResourceCardsDeck(existingDeck : ResourceCardsDeck)
        + revealBackDeckCard() GameResource
    }

    %% --------------------------------
    %% Enumerations
    %% --------------------------------
    class CardType {
        <<enumeration>>
        RESOURCE_CARD
        GOLD_CARD
        STARTER_CARD
        OBJECTIVE_CARD
    }
    class GameObject {
        <<enumeration>>
        QUILL
        INKWELL
        MANUSCRIPT
    }
    class GameResource {
        <<enumeration>>
        PLANT
        ANIMAL
        FUNGI
        INSECT
    }
    class GameState{
        <<enumeration>>
        WAITING_PLAYERS
        PLAYING
        GAME_ENDED
    }
    class PlacementResult {
        <<enumeration>>
        SUCCESS,
        NO_COVERED_CORNER,
        NOT_LEGIT_CORNER,
        MULTIPLE_CORNERS_COVERED,
        CARD_ALREADY_PRESENT,
        INDEXES_OUT_OF_GAME_FIELD,
        PLACING_CONDITION_NOT_MET
    }
    class TokenColor {
        <<enumeration>>
        BLUE
        GREEN
        RED
        YELLOW
    }
    class GameItem {
        <<interface>>
    }

    class GameField {
        - DIM: int$
        - cardsContent: PlaceableCard[81][81]
        - cardsFace: boolean [81][81]
        - cardsOrder: int[81][81]
        - numPlayedCards: int
        - starterCard: PlaceableCard
        + GameField(starterCard: PlaceableCard)
        + GameField(existingGameField: GameField)
        + getDim() int
        + getStarterCard() Placeablecard
        + placeCard(card: PlaceableCard, x: int, y: int, way: boolean)
        + isCardPresent(x: int, y: int) boolean
        + getPlacedCard(x: int, y: int) PlaceableCard
        + removePlacedcard(x: int, y: int)
        + getCardWay(x: int, y: int) boolean
        + getCardsOrder() int[81][81]
        + getNumPlayedCards() int
    }

    class Player {
        - nickname: String
        - tokenColor: TokenColor
        - isFirst: boolean
        - connectionType: boolean
        - interfaceType: boolean
        - isConnected: boolean
        - currentHand: List ~DrawableCard~
        - secretObjectve: ObjectiveCard
        - isStalled : boolean
        + Player(nickname: String, tokenColor: TokenColor, connectionType: boolean,\n interfaceType: boolean)
        + Player(existingPlayer: Player)
        + getNickname() String
        + getTokenColor() TokenColor
        + setFirst()
        + getIsStalled() boolean
        + setIsStalled(isStalled : boolean)
        + isFirst() boolean
        + isConnected() boolean
        + setIsConnected(isConnected: boolean)
        + getCurrentHand() List~DrawableCard~
        + removeCardHand(DrawableCard card)
        + addCardHand(DrawableCard card)
        + setSecretObjective(ObjectiveCard secrectObjective)
        + getSecretObjetive() ObjectiveCard
        + getConnectionType() boolean
        + getInterfaceType() boolean
    }

    class ScoreTrackBoard {
        - playersScore: Map~String, Integer~
        + ScoreTrackBoard()
        + addPlayer(nickname: String)
        + setScore(nickname: String, newScore: int)
        + getScore(nickname: String) int
        + incrementScore(nickname: String, deltaScore: int)
    }

    %% -----------------------------------------
    %%  CONTROLLER
    %% -----------------------------------------
    class Game {
        - id: int
        - state: GameState
        - playersNumber: int
        - playersGameField: Map~String, GameField~
        - players: List~Player~
        - currPlayer: int
        - scoreTrackBoard: ScoreTrackBoard
        - resourceCardsDeck: ResourceCardsDeck
        - goldCardsDeck: GoldCardsDeck
        - objectiveCardsDeck: PlayingDeck~ObjectiveCard~
        - starterCardsDeck: Deck~PlaceableCard~
        - penultimateRound: boolean
        - additionalRound : boolean
        - chat: Chat
        - gameCommand: GameCommand

        %% constructor and getters
        + Game(id: int, playersNumber: int, resourceCardsDeck: ResourceCardsDeck,\n goldCardsDeck: GoldCardsDeck, objectiveCardsDeck: PlayingDeck~ObjectiveCard~, starterCardsDeck : Deck~PlaceableCard~)
        ~ getId() int
        ~ setState(state: GameState)
        ~ getState() GameState
        ~ hasPlayer(String nickname) boolean
        ~ getPlayersNumber() int
        ~ getPlayersGameField() Map<String, GameField>
        ~ getPlayers() List<Player>
        ~ setCurrPlayer(int currPlayer)
        ~ getCurrPlayer() int
        ~ getScoreTrackBoard() ScoreTrackBoard
        ~ getResourceCardsDeck() ResourceCardsDeck
        ~ getGoldCardsDeck() GoldCardsDeck
        ~ getObjectiveCardsDeck() PlayingDeck<ObjectiveCard>
        ~ getStarterCardsDeck() Deck<PlaceableCard>
        ~ setTwentyPointsReached(boolean penultimateRound)
        ~ getTwentyPointsReached() boolean
        ~ getAdditionalRound() boolean
        ~ getChat() Chat
        + setCommand(GameCommand gameCommand)
        + execute() CommandResult

        %% public methods - called by users
        + placeStarterCard(nickname : String, way: boolean)
        + drawDeckCard(nickname: String, type: CardType)
        + drawFaceUpCard(nickname: String, type : CardType, pos:int)
        + revealFaceUpCard(type: CardType, pos:int) Card
        + revealBackDeckCard(type: CardType) GameResource
        + getLastChatMessage(receiver: String) Message
        + getChatContent(receiver: String) List~Message~
        %% private methods - internal methods
        - getPlayerByNickname(nickname : String) int
        - changeCurrPlayer()
        - computeWinner() List~Player~
    }

    class GameCommand {
        <<interface>>
    }

    class AddPlayerCommand {
        - gameController: Game
        - newPlayer: Player
        + AddPlayerCommand(gameController: Game, newPlayer: Player)
        - isFull() boolean
        - setup()
    }

    class AddChatPrivateMessageCommand {
        - gameController: Game
        - content: String
        - sender: String
        - receiver: String
        + AddChatPrivateMessageCommand(gameController: Game, content: String, sender: String, receiver: String)
    }

    class AddChatPublicMessageCommand {
        - gameController: Game
        - content: String
        - sender: String
        + AddChatPublicMessageCommand(gameController: Game, content: String, sender: String)
    }

    class PlaceCardCommand {
        - gameController: Game
        - nickname: String
        - card: DrawableCard
        - x: int
        - y: int
        - way: boolean
        + PlaceCardCommand(gameController: Game, nickname: String, card: DrawableCard, x: int, y: int, way: boolean)
        - addPoints(nickname: String, x: int, y: int)
    }

    class DisconnectPlayerCommand {
        - gameController: Game
        - nickname: String
        + DisconnectPlayerCommand(gameController: Game, nickname: String)
    }

    class ReconnectPlayerCommand {
        - gameController: Game
        - nickname: String
        + ReconnectPlayerCommand(gameController: Game, nickname: String)
    }

    class DrawFaceUpCardCommand {
        - GAME: Game
        - NICKNAME: String
        - TYPE: CardType
        - POS: int
        + DrawFaceUpCardCommand(gameController: Game, nickname: string, type: CardType, pos: int)
    }

    class PlaceStarterCardCommand {
        - GAME: Game
        - NICKNAME: String
        - TYPE: CardType
        - WAY: boolean
        + PlaceStarterCardCommand(gameController: Game, nickname: string, way: boolean)
    }

    class DrawDeckCardCommand {
        - GAME : gameController
        - NICKNAME : String
        - TYPE : CardType
        + DrawDeckCardCommand (gameController: Game, nickname: string, type: CardType)
    }

    class GamesManager {
        - games: List~Game~
        - pendingPlayers: List~Player~
        + GamesManager()
        + addPlayer(nickname: String, tokenColor: TokenColor, connectionType: boolean, interfaceType: boolean)
        + checkNicknameUnique(nickname: String) boolean
        + createGame(playersNumber : int) int
        + displayExistingGame()
        + getPendingPlayer(nickname: String)
        + joinExistingNickname(nickname: String, gameId : int)
        + joinNewGame(nickname: String)
    }

    class DecksBuilder{
        <<abstract>>
        - extractFrontCorners(cardJsonObject : JsonObject) boolean[4]
        - extractFrontCornersContent(cardJsonObject : JsonObject) GameItem[4]
        - extractBackCorners(cardJsonObject : JsonObject) boolean[4]
        - extractBackCornersContent(cardJsonObject : JsonObject) GameItem[4]
        - extractPermanentResources(cardJsonObject : JsonObject) List~GameResource~
        - extractLayoutCondition(conditionObject : JsonObject) GameResource[4][3]
        - extractItemsCondition(conditionObject : JsonObject) List~GameItem~
        + buildStarterCardsDeck() Deck~PlaceableCard~
        + buildObjectiveCardsDeck() PlayingDeck~ObjectiveCard~
        + buildResourceCardsDeck() ResourceCardsDeck
        + buildGoldCardsDeck() GoldCardsDeck
    }



    %% CONTROLLER
    class GameController {
        - gameModel: GameModel
        - timer: timeout
        - playersTimer: Map~String, Timer~
        - emptyDeck: boolean
        + GameController(id: int, playersNumber:int , resourceCardsDeck: DrawableDeck~DrawableCard~ ,goldCardsDeck: DrawableDeck~GoldCard~ , objectiveCardsDeck: PlayingDeck~ObjectiveCard~ ,starterCardsDeck: Deck~PlaceableCard~ )
        ~ getId() int
        ~ setState(state: GameState)
        ~ getState() GameState
        + getPlayers() List~Player~
        ~ getPlayersNumber() int
        ~ getWinners() List~String~
        + getCurrPlayer() int
        ~ setHasCurrPlayerPlaced()
        ~ setHasNotCurrPlayerPlaced()
        ~ getHasCurrPlayerPlaced() boolean
        ~ getScoreTrackBoard() ScoreTrackBoard
        ~ getResourceCardsDeck() DrawableDeck~DrawableCard~
        ~ getGoldCardsDeck() DrawableDeck~GoldCard~
        ~ getObjectiveCardsDeck() PlayingDeck~ObjectiveCard~
        ~ getStarterCardsDeck() Deck~PlaceableCard~
        ~ setTwentyPointsReached()
        ~ setCurrentPlayer(num: int)
        + getCommandResult() CommandResult
        + setAndExecuteCommand(gameCommand: GameCommand)
        + addListener(client: VirtualView)
        + addChatPrivateMessage(content: String, sender: String, receiver: String)
        + addChatPublicMessage(content: String, sender: String )
        + addPlayer(newPlayer: Player)
        + disconnectPlayer(nickname: String)
        + drawDeckCard(nickname: String, type: CardType)
        + drawFaceUpCard(nickname: String, type: CardType, pos: int)
        + placeCard(nickname: String,  pos: int,  x: int, y : int, way: boolean)
        + placeStarterCard(nickname: String, way: boolean)
        + reconnectPlayer(nickname: String)
        ~ hasPlayer(nickname: String) boolean
        ~ hasPlayerWithTokenColor(tokenColor: TokenColor) boolean
        - getPlayerPosByNickname(nickname: String) int
        ~ changeCurrPlayer ()
        - isFull() boolean
        - setup()
        - addPoints(nickname: String, x:int, y:int)
    }

    class GamesManager{
        - myGamesManager: GamesManager√†
        - gameControllers: List~GameController~
        - pendingPlayers:  List~Player~
        - commandResult: CommandResult
        - GamesManager()
        + getGamesManager() GamesManager
        + resetGamesManager()
        ~ getGames() List~GameController~
        + getFreeGamesDetails() Map~Integer, Integer~
        + getGameById(id: int) GameController
        + getCommandResult() CommandResult
        + setAndExecuteCommand(gamesManagerCommand: GamesManagerCommand)
        ~ getPendingPlayer(nickname: String) Player
        + getGameIdWithPlayer(nickname: String) int
        + addPlayerToPending( nickname: String, connectionType: boolean, interfaceType: boolean )
        - checkReconnection(nickname: String) boolean
        - checkNicknameUnique(nickname: String) boolean
        + joinExistingGame( nickname: String, tokenColor: TokenColor, gameId: int)
        + joinNewGame(nickname: String, tokenColor: TokenColor, playersNumber: int)
        - createGame (playersNumber: int) int
        - findFirstFreeId() int
        + displayExistingGames(nickname: String)
        + deleteGame(id: int)
    }

    %% GAME_COMMANDS
    class AddChatPrivateMessageCommand{
        - content: String
        - sender: String
        - receiver: String
        + AddChatPrivateMessageCommand(content: String, sender: String, receiver:String)
        + execute(gameController: GameController)
    }
    class AddChatPublicMessageCommand{
        - content: String
        - sender: String
        + AddChatPublicMessageCommand(content: String, sender: String)
        + execute(gameController: GameController)
    }
    class AddPlayerToPendingCommand{
        - nickname: String
        - connectionType: boolean
        - interfaceType: boolean
        + AddPlayerToPendingCommand(nickname: String, connectionType: boolean, interfaceType: boolean )
        + getNickname() string
        + execute(gamesManager: GamesManager)
    }
    class DisconnectPlayerCommand{
        ~ nickname: String
        + DisconnectPlayerCommand (nickname: String)
        + execute(gameController: GameController)
    }
    class DisplayGamesCommand{
        - nickname: String
        + DisplayGamesCommand (nickname: String)
        + getNickname() String
        + execute(gamesManager: GamesManager)
    }
    class DrawDeckCardCommand{
        - nickname: String
        - type: CardType
        + DrawDeckCardCommand (nickname: String, type: CardType)
        + execute(gameController: GameController)
    }
    class DrawFaceUpCardCommand{
        - nickname: String
        - type: CardType
        - pos: int
        + DrawFaceUpCardCommand (nickname: String, type: CardType, pos: int)
        + execute(gameController: GameController)
    }
    class GameCommand{
        <<interface>>
        ~ execute(gameController: GameController)
    }
    class GamesManagerCommand{
        <<interface>>
        ~ getNickname() String
        ~ execute(gamesManager: GamesManager)
    }
    class JoinExistingGameCommand{
        - nickname: String
        - tokenColor: TokenColor
        - gameId: int
        + JoinExistingGameCommand(nickname: String, tokenColor: TokenColor , gameId: int)
        + getNickname() String
        + execute(gamesManager: GamesManager)
    }
    class JoinNewGameCommand{
        - nickname: String
        - tokenColor: TokenColor
        - playersNumber: int
        + JoinNewGameCommand(nickname: String, tokenColor: TokenColor, playersNumber: int)
        + getNickname(): String
        + execute(gamesManager: GamesManager)
    }
    class PlaceCardCommand{
        - nickname: String
        - pos: int
        - x: int
        - y: int
        - way: boolean
        + PlaceCardCommand(nickname: String, pos: int, x: int, y:int,way: boolean)
        + execute(gameController: GameController)
    }
    class PlaceStarterCardCommand{
        - nickname: String
        - way: boolean
        + PlaceStarterCardCommand(nickname: String, way: boolean)
        + execute(gameController: GameController)
    }
